<!doctype html>

<html lang="cs">

<head>
    <meta charset="utf-8">

    <title>Map window</title>
    <meta name="description" content="Map window">
    <meta name="author" content="Adam Kučera">

    <script src="https://api.mapy.cz/loader.js"></script>
    <script>
        Loader.load(null, {suggest: true});
    </script>
</head>

<body style="padding:0px; margin:0px;">
    <div id="map" style="width:100%; height:500px; border:0px; padding:0px; margin:0px;"></div>
    <script>
        var MapProxy = {
            map: null,
            markerLayer: null,

            click: function (loc) {
                if (this.clickHandler) {
                    this.clickHandler(loc);
                }
            },
            changeExtent: function (extent) {
                if (this.extentHandler) {
                    this.extentHandler(extent);
                }
            },
            markerClick: function (id) {
                if (this.markerClickHandler) {
                    this.markerClickHandler(id);
                }
            },

            removeMarkers: function() {
                this.markerLayer.removeAll();
            },

            addMarkers: function(markers) {
                markers.forEach(m => {
                    this.markerLayer.addMarker(new SMap.Marker(SMap.Coords.fromWGS84(m.lon, m.lat), m.id, {}));
                });
            },

            /*
            activateSuggest(el) {
                var suggest = new SMap.Suggest(el);
                suggest.map(this.map);
                suggest.addListener("suggest", function(suggestData) {
                    alert(suggestData.phrase);
                    console.dir(suggestData);
                }).addListener("close", function() {
                    console.log("suggest closed");
                });
            },
            */
            clickHandler: null,
            extentHandler: null,
            markerClickHandler: null,
        };
        document.MapProxy = MapProxy;
        var center = SMap.Coords.fromWGS84(14.41, 50.08);
        var map = new SMap(JAK.gel("map"), center, 10);
        
        MapProxy.map = map;
        map.addDefaultControls();
        var mouse = new SMap.Control.Mouse(SMap.MOUSE_PAN | SMap.MOUSE_WHEEL | SMap.MOUSE_ZOOM);
        map.addControl(mouse); 
        map.addDefaultLayer(SMap.DEF_BASE).enable();
        var layer = new SMap.Layer.Marker();
        map.addLayer(layer);
        layer.enable();
        MapProxy.markerLayer = layer;

        var sync = new SMap.Control.Sync({bottomSpace:30});
        map.addControl(sync);

        var mapClick = function (signal) {
            var event = signal.data.event;
            var coords = SMap.Coords.fromEvent(event, map);
            MapProxy.click(coords);
        }

        var markerClick = function(signal) {
            // vybrany marker
            var marker = signal.target;
            var id = marker.getId();
            MapProxy.markerClick(id);
        }

        var mapRedraw = function(signal) {
            var vp = map.getViewport();
            //console.log(map.getZoom());
            MapProxy.changeExtent({
                lon: { min: Math.min(vp.lbx, vp.rtx), max: Math.max(vp.lbx, vp.rtx) },
                lat: { min: Math.min(vp.lby, vp.rty), max: Math.max(vp.lby, vp.rty) },
            });
        }

        var signals = map.getSignals();
        signals.addListener(window, "map-click", mapClick);
        signals.addListener(window, "marker-click", markerClick);
        signals.addListener(window, "map-redraw", mapRedraw);
    </script>
</body>

</html>